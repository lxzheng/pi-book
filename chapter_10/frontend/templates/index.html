<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§æµ‡èŠ±ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 45% 55%;
            gap: 20px;
        }
        
        /* å·¦ä¾§ç…§ç‰‡åŒºåŸŸ */
        .left-section {
            padding: 20px;
        }

        .photo-container {
            border-radius: 5px;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        #plant-photo {
            max-width: 100%;
            height: auto;
        }
        
        /* å³ä¾§æ§åˆ¶åŒºåŸŸ */
        .right-section {
            padding: 20px;
        }
        
        .status-section, .control-section {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .status-item {
            margin-bottom: 15px;
        }
        
        .control-item {
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        input[type="number"] {
            padding: 5px;
            width: 60px;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
        }

        h3 {
            color: #666;
            margin-bottom: 10px;
        }
        
        .status-cards {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .status-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
            margin: 10px 0;
        }
        
        .status-label {
            color: #666;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .status-icon {
            font-size: 24px;
            margin-bottom: 10px;
            color: #4CAF50;
        }
        
        /* èŠå¤©ç•Œé¢æ ·å¼ */
        .chat-section {
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            background: #f9f9f9;
        }
        
        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .user-message {
            background: #4CAF50;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }
        
        .bot-message {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }
        
        .chat-input {
            display: flex;
            gap: 10px;
        }
        
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .chat-input button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .chat-input button:hover {
            background: #45a049;
        }
        
        .chat-input button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        
        .photo-history {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            padding: 15px;
            background: white;
        }
        
        .history-item {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            background: #f9f9f9;
            transition: transform 0.2s;
        }
        
        .history-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .history-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .history-time {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }
        
        .history-comment {
            color: #333;
            font-style: normal;
            margin-top: 10px;
            line-height: 1.5;
        }
        
        .history-comment p {
            margin: 5px 0;
        }
        
        .history-comment strong {
            color: #4CAF50;
        }
        
        .history-container {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }
        
        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        .history-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .history-container::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        .history-container::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
    <h1>æ™ºæ…§æµ‡èŠ±ç³»ç»Ÿ</h1>
    
    <div class="main-container">
        <!-- å·¦ä¾§ï¼šç…§ç‰‡åŒºåŸŸ -->
        <div class="left-section">
            <!-- å½“å‰ç…§ç‰‡åŒºåŸŸ -->
            <div class="photo-container">
                <h2>æœ€æ–°ç…§ç‰‡</h2>
                <div class="photo-container">
                    <img id="plant-photo" src="/static/flower.jpg" alt="æ¤ç‰©ç…§ç‰‡">
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button id="photo-button" onclick="takePhoto()">æ‹ç…§</button>
                </div>
            </div>
            
            <!-- å†å²è®°å½•åŒºåŸŸ -->
            <div class="photo-history">
                <h2>å†å²è®°å½•</h2>
                <div class="history-container" id="photo-history">
                    <!-- å†å²è®°å½•å°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šçŠ¶æ€å’Œæ§åˆ¶åŒºåŸŸ -->
        <div class="right-section">
            <!-- çŠ¶æ€åŒºåŸŸ -->
            <div class="status-section">
                <h2>è®¾å¤‡çŠ¶æ€</h2>
                <div class="status-cards">
                    <!-- <div class="status-card">
                        <div class="status-icon">ğŸ’¡</div>
                        <div class="status-label">è¡¥å…‰ç¯</div>
                        <div class="status-value" id="soil-moisture">å·²å…³é—­</div>
                    </div> -->

                    <!-- æ°´æ³µçŠ¶æ€å¡ç‰‡ -->
                    <div class="status-card">
                        <div class="status-icon">ğŸ’§</div>
                        <div class="status-label">æ°´æ³µçŠ¶æ€</div>
                        <div class="status-value" id="pump-status">åŠ è½½ä¸­...</div>
                    </div>
                    
                    <!-- åœŸå£¤æ¹¿åº¦å¡ç‰‡ -->
                    <div class="status-card">
                        <div class="status-icon">ğŸŒ±</div>
                        <div class="status-label">åœŸå£¤æ¹¿åº¦</div>
                        <div class="status-value" id="soil-moisture">åŠ è½½ä¸­...</div>
                    </div>

                    
                </div>
            </div>
            
            <!-- æ§åˆ¶åŒºåŸŸ -->
            <div class="control-section">
                <h2>æ§åˆ¶é¢æ¿</h2>
                <div class="control-item">
                    <h3>æµ‡æ°´æ§åˆ¶</h3>
                    <input type="number" 
                           id="water-duration" 
                           min="1" 
                           max="10" 
                           value="1" 
                           style="width: 60px;">
                    <span>ç§’</span>
                    <button id="water-button" onclick="startWatering()">å¼€å§‹æµ‡æ°´</button>
                </div>
            </div>
            
            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="chat-section">
                <h2>æ™ºèƒ½åŠ©æ‰‹</h2>
                <div class="chat-messages" id="chat-messages">
                    <!-- æ¶ˆæ¯ä¼šåœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                    <div class="message bot-message">
                        ä½ å¥½ï¼æˆ‘æ˜¯ä½ çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®ä½ çš„å—ï¼Ÿ
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" 
                           id="chat-input" 
                           placeholder="è¾“å…¥ä½ çš„é—®é¢˜..."
                           onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()" id="send-button">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å®šæœŸæ›´æ–°è®¾å¤‡çŠ¶æ€
        function updateDeviceStatus() {
            console.log('å¼€å§‹è·å–è®¾å¤‡çŠ¶æ€...');
            fetch('/get-device-shadow')
                .then(response => response.json())
                .then(data => {
                    console.log('æ”¶åˆ°çš„æ•°æ®:', data);
                    if (data.success && data.data.shadow && 
                        data.data.shadow[0].reported.properties) {
                        
                        const properties = data.data.shadow[0].reported.properties;
                        console.log('è®¾å¤‡å±æ€§:', properties);
                        
                        // æ›´æ–°æ°´æ³µçŠ¶æ€
                        const pumpStatus = properties.pump ? "æ­£åœ¨æµ‡æ°´" : "å·²å…³é—­";
                        const pumpElement = document.getElementById('pump-status');
                        console.log('æ°´æ³µçŠ¶æ€:', pumpStatus);
                        pumpElement.textContent = pumpStatus;
                        pumpElement.style.color = properties.pump ? '#ff4444' : '#4CAF50';
                        
                        // æ›´æ–°åœŸå£¤æ¹¿åº¦
                        const soilMoisture = Math.round(properties.soil);
                        const soilElement = document.getElementById('soil-moisture');
                        console.log('åœŸå£¤æ¹¿åº¦:', soilMoisture);
                        soilElement.textContent = `${soilMoisture}%`;
                        
                        // æ ¹æ®æ¹¿åº¦å€¼æ”¹å˜é¢œè‰²
                        if (soilMoisture >= 70) {
                            soilElement.style.color = '#4CAF50';
                        } else if (soilMoisture >= 30) {
                            soilElement.style.color = '#ffa726';
                        } else {
                            soilElement.style.color = '#ff4444';
                        }
                    }
                })
                .catch(error => {
                    console.error('è·å–è®¾å¤‡çŠ¶æ€å¤±è´¥:', error);
                    document.getElementById('pump-status').textContent = 'è·å–å¤±è´¥';
                    document.getElementById('soil-moisture').textContent = 'è·å–å¤±è´¥';
                });
        }

        // æ§åˆ¶æµ‡æ°´
        function startWatering() {
            const duration = parseInt(document.getElementById('water-duration').value);
            const waterButton = document.getElementById('water-button');
            
            // éªŒè¾“å…¥
            if (isNaN(duration) || duration < 1 || duration > 10) {
                alert('è¯·è¾“å…¥1-10ç§’ä¹‹é—´çš„æµ‡æ°´æ—¶é—´ï¼');
                return;
            }
            
            // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
            waterButton.disabled = true;
            waterButton.textContent = 'æµ‡æ°´ä¸­...';
            
            fetch('/control-pump', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ duration: duration })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`å¼€å§‹æµ‡æ°´ ${duration} ç§’`);
                    // ç­‰å¾…æµ‡æ°´å®Œæˆåæ›´æ–°çŠ¶æ€
                    setTimeout(() => {
                        updateDeviceStatus();
                        waterButton.disabled = false;
                        waterButton.textContent = 'å¼€å§‹æµ‡æ°´';
                    }, duration * 1000 + 1000); // å¤šç­‰å¾…1ç§’ç¡®ä¿çŠ¶æ€æ›´æ–°
                } else {
                    alert('æµ‡æ°´å¤±è´¥: ' + data.error);
                    waterButton.disabled = false;
                    waterButton.textContent = 'å¼€å§‹æµ‡æ°´';
                }
            })
            .catch(error => {
                alert('æ“ä½œå¤±è´¥: ' + error);
                waterButton.disabled = false;
                waterButton.textContent = 'å¼€å§‹æµ‡æ°´';
            });
        }

        // æ§åˆ¶ç›¸æœºæ‹ç…§
        function takePhoto() {
            const photoButton = document.getElementById('photo-button');
            photoButton.disabled = true;
            photoButton.textContent = 'æ‹ç…§ä¸­...';
            
            fetch('/take-photo')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ç­‰å¾…3ç§’è®©è®¾å¤‡æœ‰æ—¶é—´æ‹ç…§å’Œä¸Šä¼ 
                        setTimeout(() => {
                            const newPhotoUrl = `/static/flower.jpg?t=${new Date().getTime()}`;
                            // æ›´æ–°å½“å‰ç…§ç‰‡
                            document.getElementById('plant-photo').src = newPhotoUrl;
                            
                            // è¯·æ±‚AIè¯„è®º
                            return fetch('/analyze-photo', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ photoUrl: newPhotoUrl })
                            });
                        }, 3000);
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æ·»åŠ åˆ°å†å²è®°å½•
                        addPhotoHistory(
                            `/static/flower.jpg?t=${new Date().getTime()}`,
                            data.comment,
                            new Date().getTime()
                        );
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('æ‹ç…§æˆ–åˆ†æè¿‡ç¨‹å‡ºé”™ï¼š' + error);
                })
                .finally(() => {
                    photoButton.disabled = false;
                    photoButton.textContent = 'æ‹ç…§';
                });
        }

        // ç¡®ä¿é¡µé¢åŠ è½½å®Œæˆåç«‹å³æ‰§è¡Œä¸€æ¬¡
        document.addEventListener('DOMContentLoaded', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ›´æ–°çŠ¶æ€');
            updateDeviceStatus();
            setInterval(updateDeviceStatus, 1000);

            // åˆå§‹åŒ–èŠå¤©å†å²
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.innerHTML = ''; // æ¸…ç©ºç°æœ‰æ¶ˆæ¯

            // æ·»åŠ å†å²å¯¹è¯
            const chatHistory = [
                { text: 'å¸®æˆ‘æµ‡æ°´3ç§’å§', type: 'user' },
                { text: 'æˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼šæµ‡æ°´ 3 ç§’', type: 'bot' },
                { text: 'æ‹å¼ ç…§', type: 'user' },
                { text: 'æˆåŠŸæ‰§è¡Œå‘½ä»¤ï¼šæ‹ç…§', type: 'bot' },
                { text: 'ä¹±è¯´ä¸€å¥è¯', type: 'user' },
                { text: 'æŠ±æ­‰ï¼Œå½“å‰ç¡¬ä»¶æ²¡æœ‰é…ç½®è¿™ä¸ªä»»åŠ¡ï¼', type: 'bot' }
            ];

            // æ·»åŠ æ‰€æœ‰å†å²æ¶ˆæ¯
            chatHistory.forEach(msg => {
                addMessage(msg.text, msg.type);
            });
        });

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // ç¦ç”¨è¾“å…¥å’ŒæŒ‰é’®
            input.disabled = true;
            document.getElementById('send-button').disabled = true;
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage(message, 'user');
            
            // æ¸…ç©ºè¾“å…¥
            input.value = '';
            
            // å‘é€åˆ°åç«¯
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ message: message })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // æ·»åŠ æœºå™¨äººå›å¤
                    addMessage(data.response, 'bot');
                } else {
                    addMessage('æŠ±æ­‰ï¼Œæˆ‘é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼š' + data.error, 'bot');
                }
            })
            .catch(error => {
                addMessage('æŠ±æ­‰ï¼Œå‘ç”Ÿäº†é”™è¯¯ï¼š' + error, 'bot');
            })
            .finally(() => {
                // é‡æ–°å¯ç”¨è¾“å…¥å’ŒæŒ‰é’®
                input.disabled = false;
                document.getElementById('send-button').disabled = false;
                input.focus();
            });
        }
        
        function addMessage(text, type) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.textContent = text;
            messagesDiv.appendChild(messageDiv);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // æ·»åŠ æ–°çš„å†å²è®°å½•
        function addPhotoHistory(imageUrl, comment, timestamp) {
            const historyContainer = document.getElementById('photo-history');
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            
            const date = new Date(timestamp);
            const formattedTime = date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // åˆ›å»ºä¸€ä¸ªä¸“é—¨çš„divæ¥æ”¾ç½®markdownå†…å®¹
            const commentDiv = document.createElement('div');
            commentDiv.className = 'history-comment';
            // ä½¿ç”¨innerHTMLæ¥è®¾ç½®è§£æåçš„markdownå†…å®¹
            commentDiv.innerHTML = marked.parse(comment);
            
            historyItem.innerHTML = `
                <div class="history-time">${formattedTime}</div>
                <img src="${imageUrl}" alt="å†å²ç…§ç‰‡" class="history-image">
            `;
            
            // å°†è§£æåçš„markdownå†…å®¹æ·»åŠ åˆ°å†å²è®°å½•é¡¹
            historyItem.appendChild(commentDiv);
            
            historyContainer.insertBefore(historyItem, historyContainer.firstChild);
        }

        // é¡µé¢åŠ è½½æ—¶æ·»åŠ ä¸€äº›æµ‹è¯•æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            // æ·»åŠ ç¤ºä¾‹å†å²è®°å½•
            addPhotoHistory(
                '/static/flower.jpg',
                '**æ—¥æœŸ**ï¼š2024/12/31 \n\n\
**å¤©æ°”**ï¼šæ™´æœ—\n\n\
**åœŸå£¤æ¹¿åº¦**ï¼š100%\n\n\
**èŠ±å‰çŠ¶æ€**ï¼šå›¾ä¸­çš„èŠ±å‰å‘ˆç°å‡ºæ¯èçš„çŠ¶æ€ï¼ŒèŠ±ç“£å¹²æ¯å‘çš±ä¸”é¢œè‰²æš—æ²‰ï¼ŒèŠ±æœµæ•´ä½“å·²å¤±å»äº†ç”Ÿæœºã€‚\n\n\
**åˆ†æä¸å±•æœ›**ï¼šè™½ç„¶å¤©æ°”æ™´æœ—ï¼Œä½†åœŸå£¤æ¹¿åº¦è¾¾åˆ°äº†100%ï¼Œè¿™å¯èƒ½å¯¼è‡´åœŸå£¤ç§¯æ°´ï¼Œä½¿èŠ±å‰æ ¹éƒ¨ç¼ºæ°§ï¼Œè¿›è€Œå½±å“å…¶æ­£å¸¸ç”Ÿé•¿ã€‚ç›®å‰èŠ±å‰å·²å¤„äºæ¯èçŠ¶æ€ï¼Œè‹¥åœŸå£¤æ¹¿åº¦æŒç»­è¿‡é«˜ï¼Œå¯èƒ½ä¼šåŠ é‡èŠ±å‰çš„æ¯èç¨‹åº¦ï¼Œç”šè‡³å¯¼è‡´æ ¹éƒ¨è…çƒ‚ã€‚æœªæ¥éœ€è¦é€‚å½“é™ä½åœŸå£¤æ¹¿åº¦ï¼Œä¿æŒåœŸå£¤çš„é€æ°”æ€§ï¼Œä»¥åˆ©äºèŠ±å‰æ¢å¤ç”Ÿæœºã€‚',
                new Date().getTime() - 86400000 // æ˜¨å¤©
            );
            // addPhotoHistory(
            //     '/static/flower.jpg',
            //     'è§‚å¯Ÿåˆ°æ–°çš„èŠ±è‹ï¼Œè®°å¾—é€‚å½“æµ‡æ°´',
            //     new Date().getTime() - 172800000 // å‰å¤©
            // );
        });
    </script>
</body>
</html> 